---
title: "Nitrogen Updates"
author: "YSSP"
date: "2023-05-27"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(rphydro)
library(tidyverse)
library(ggplot2)
library(reshape2)
```
## Parameters

Carbon allocation was 0 for fertalised, 0.2 for unfertalised (Fransson 2024)
Original jmax = 86.02379

So set a_jmax as 800 to get the equlibrium point around 80 as an original.

```{r}
kphio = 0.087;        # quantum yield efficiency
ppfd = 300;          # umol/m2/s
ppfd_max = 1200;
vpd  = 1000;         # Pa
co2  = 400;          # ppm
elv  = 0;            # m.a.s.l.
fapar = 0.7;         # fraction
rdark = 0.015;
tc = 25;
vwind = 3;
netrad = ppfd/2
psi_soil = -0.05
a_jmax = 800         # TODO: real value

nitrogen = 0.012     # TODO: real value
pa = calc_patm(elv)

par_cost = list(alpha=0.1, gamma=1, carbon_allocation = 1);
par_plant = list(conductivity=3e-17, psi50=-2, b=2);
options = list(gs_method = "GS_IGF", 
               et_method = "ET_DIFFUSION",
               ftemp_vj_method = "FV_kumarathunge19",
               ftemp_rd_method = "FR_heskel16",
               ftemp_br_method = "FB_atkin15",
               scale_alpha = F)
```


## Acclimating (Weekly) Response

```{r}
dat = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_nitrogen(tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, par_cost, options))) %>% unnest_wider(dat)

dat_original = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_numerical(tc, tc, .x, netrad, vpd, co2, pa, fapar, kphio, psi_soil, rdark, vwind, par_plant, par_cost, options))) %>% unnest_wider(dat)
```

```{r}
df.m <- dat %>% melt("ppfd")
df_original.m <- dat_original %>% melt("ppfd")

ggplot() + 
  geom_line(data = df_original.m, aes(y = value, x = ppfd, color = "Numeric")) +
  geom_line(data = df.m, aes(y = value, x = ppfd, color = "N Included")) +
  scale_color_manual(values = c("N Included" = "aquamarine4", "Numeric" = "red")) +
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1),
        legend.title = element_blank()) +
  facet_wrap(~variable, scales = "free")
```

## Instantaneous Response

```{r}
acc = dat %>% filter(ppfd == 1200)
dat_inst = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_instantaneous_nitrogen(acc$vcmax25, acc$jmax25, tc, tc, .x, netrad, vpd, co2, pa, nitrogen, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, par_cost, options))) %>% unnest_wider(dat)

acc_original = dat_original %>% filter(ppfd == 1200)
dat_inst_original = tibble(ppfd = seq(1,1200,length.out=50)) %>% mutate(dat = purrr::map(.x=ppfd, .f = ~rphydro_instantaneous_numerical(acc$vcmax25, acc$jmax25, tc, tc, .x, netrad, vpd, co2, pa, fapar, kphio, psi_soil, rdark, vwind, par_plant, par_cost, options))) %>% unnest_wider(dat)

df.m.inst <- dat_inst %>% melt("ppfd")
df_original.m.inst <- dat_inst_original %>% melt("ppfd")

ggplot() + 
  geom_line(data = df_original.m.inst, aes(y = value, x = ppfd, color = "Numeric")) +
  geom_line(data = df.m.inst, aes(y = value, x = ppfd, color = "N Included")) +
  scale_color_manual(values = c("N Included" = "aquamarine4", "Numeric" = "red")) +
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1),
        legend.title = element_blank()) +
  facet_wrap(~variable, scales = "free")
```

### Compare ac, aj, in inst responses - TODO: check formula

```{r}
par(mfrow = c(1, 2))
dat_inst %>% select(ac, aj, isVcmaxLimited) %>% mutate(isVcmaxLimited = isVcmaxLimited*5) %>%  matplot(x=dat_inst$ppfd, type="l", lty=1, col=c("green4", "yellow3", "black"))
abline(v=0, col="pink")
dat_inst_original %>% select(ac, aj, isVcmaxLimited) %>% mutate(isVcmaxLimited = isVcmaxLimited*5) %>%  matplot(x=dat_inst$ppfd, type="l", lty=2, col=c("green4", "yellow3", "black"))
abline(v=0, col="pink")
```

### J Behaviour

```{r}
a_jmax = 0.1 # TODO: real value

J_n = tibble(ppfd = seq(0,1200, length.out=50)) %>% 
  mutate(J = kphio*ppfd/sqrt(1+(4*kphio*ppfd/(acc$n_leaf * a_jmax))^2))

J_original = tibble(ppfd = seq(0,1200, length.out=50)) %>% 
  mutate(J = kphio*ppfd/sqrt(1+(4*kphio*ppfd/(acc_original$jmax))^2))

ggplot()+
  geom_line(data = J_n, aes(x=ppfd, y=J), color = "aquamarine4") +
  geom_line(data = J_original, aes(x=ppfd, y=J), color = "red") +
  labs(x = "PPFD (μmol m^-2 s^-1)", y = "J (μmol m^-2 s^-1)", 
       title = "Electron Transport Rate (J) vs. PPFD")

```

### Nitrogen response

```{r}
ppfd = 500
dat_nitrogen = tibble(nitrogen = seq(0,1,length.out=50)) %>% mutate(dat = purrr::map(.x=nitrogen, .f = ~rphydro_nitrogen(tc, tc, ppfd, netrad, vpd, co2, pa, .x, fapar, kphio, psi_soil, rdark, vwind, a_jmax, par_plant, par_cost, options))) %>% unnest_wider(dat)
```

```{r}
df_nitrogen.m <- dat_nitrogen %>% melt("nitrogen")

ggplot(df_nitrogen.m, aes(y=value, x=nitrogen)) + 
  geom_line(col="aquamarine4") + 
  theme_classic() +
  theme(strip.background = element_rect(color = "white", size = 1))+
  facet_wrap(~variable, scales = "free")

```

### Vcmax response - hasn't changed!

```{r}
df = list(tc = seq(-10, 40, length.out=50), 
     tg = seq(-10, 40, length.out=50)) %>% cross_df() %>% 
        mutate(f = purrr::pmap_dbl(.l=., .f = rr_calc_ftemp_inst_vcmax,
                        tref = 25, 
                        method = "FV_kumarathunge19"))

df %>% ggplot(aes(x=tc, y=f)) +
  geom_line(aes(col=tg, group=tg)) + 
  geom_line(data = df %>% filter(tc == tg), col="red")

df %>% ggplot(aes(x=tc, y=tg, z=f)) +
  geom_contour_filled()+
  geom_contour(breaks = 1, col="red")
```

### Jmax response - hasn't changed!

```{r}

dfj = list(tc = seq(-10, 40, length.out = 50), 
          tg = seq(-10, 40, length.out = 50),
          th = seq(-10, 40, length.out = 5)) %>% cross_df() %>% 
        mutate(f = purrr::pmap_dbl(.l=., .f = rr_calc_ftemp_inst_jmax,
                          tref = 25, 
                          method = "FV_kumarathunge19"))

dfj %>% ggplot(aes(x=tc, y=f)) +
  geom_line(aes(col=tg, group=tg)) + 
  geom_line(data = dfj %>% filter(tc == tg), col="red") + 
  facet_wrap("th", ncol=5)+
  ylim(c(0,2))

```


